# go map
go map æºç è§£æ

map å…¶å®æ˜¯ä¸€ç§å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ï¼Œå¤§å¤šæ•°è¯­è¨€éƒ½ä¼šå†…ç½®æ•°ç»„å’Œå“ˆå¸Œè¡¨ä¸¤ç§æ•°æ®ç»“æ„ã€‚

å“ˆå¸Œè¡¨çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³æ•°ç»„ä¸­æ— æ³•é€šè¿‡keyå¿«é€Ÿå®šä½åˆ°valueçš„é—®é¢˜ï¼Œå“ˆå¸Œè¡¨æä¾›äº†æ¥è¿‘äºO(1)çš„æ—¶é—´å¤æ‚åº¦æ¥è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚

## å“ˆå¸Œå‡½æ•°

å“ˆå¸Œè¡¨å®ç°O(1)çš„æ—¶é—´å¤æ‚åº¦çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

åŸºäºå“ˆå¸Œå‡½æ•°å°† key çš„ä½ç½®æå‰ç¡®å®šï¼Œæ¯æ¬¡æŸ¥æ‰¾å½“å‰ keyï¼Œä»…éœ€é€šè¿‡ key å³å¯æ‰¾åˆ° key å¯¹åº”çš„ä½ç½®ï¼Œä¸ç”¨å¯¹æ•´ä¸ªé›†åˆå…¨å±€éå†ã€‚

ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å“ˆå¸Œå‡½æ•°ç”Ÿæˆçš„ hashkey éƒ½ä¸åŒï¼Œä½†æ˜¯æ­£å¸¸æƒ…å†µä¸‹ï¼Œå“ˆå¸Œå‡½æ•°æ˜¯ä¸ä¸€å®šå®Œç¾çš„ï¼Œå½“è¾“å…¥çš„é”®è¶³å¤Ÿå¤šä¼šäº§ç”Ÿå†²çªï¼Œæ‰€ä»¥ä¼šå­˜åœ¨å‘ç”Ÿå“ˆå¸Œç¢°æ’çš„å¯èƒ½ï¼Œè¿™æ—¶å°±éœ€è¦ä¸€äº›æ–¹æ³•æ¥è§£å†³å“ˆå¸Œç¢°æ’çš„é—®é¢˜ï¼Œå¸¸è§æ–¹æ³•çš„æœ‰ï¼šå¼€æ”¾å¯»å€æ³•å’Œæ‹‰é“¾å¼ã€‚

### å¼€æ”¾å¯»å€æ³•

æ˜¯ä¸€ç§åœ¨å“ˆå¸Œè¡¨ä¸­è§£å†³å“ˆå¸Œç¢°æ’çš„æ¯”è¾ƒæ™®é€šçš„æ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**ä¾æ¬¡æ¢æµ‹å’Œæ¯”è¾ƒæ•°ç»„ä¸­çš„å…ƒç´ ä»¥åˆ¤æ–­ç›®æ ‡é”®å€¼å¯¹æ˜¯å¦å­˜åœ¨äºå“ˆå¸Œè¡¨ä¸­**
ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å¼€æ”¾å¯»å€æ³•æ¥å®ç°å“ˆå¸Œè¡¨ï¼Œé‚£ä¹ˆå®ç°å“ˆå¸Œè¡¨åº•å±‚çš„æ•°æ®ç»“æ„å°±æ˜¯æ•°ç»„ï¼Œä¸è¿‡å› ä¸ºæ•°ç»„çš„é•¿åº¦æœ‰é™ã€‚

å¼€æ”¾å¯»å€æ³•ä¸­å¯¹æ€§èƒ½å½±å“æœ€å¤§çš„æ˜¯**è£…è½½å› å­**ï¼Œå®ƒæ˜¯æ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡ä¸æ•°ç»„å¤§å°çš„æ¯”å€¼ã€‚éšç€è£…è½½å› å­çš„å¢åŠ ï¼Œçº¿æ€§æ¢æµ‹çš„å¹³å‡ç”¨æ—¶å°±ä¼šé€æ¸å¢åŠ ï¼Œè¿™ä¼šå½±å“å“ˆå¸Œè¡¨çš„è¯»å†™æ€§èƒ½ã€‚å½“è£…è½½ç‡è¶…è¿‡ 70% ä¹‹åï¼Œå“ˆå¸Œè¡¨çš„æ€§èƒ½å°±ä¼šæ€¥å‰§ä¸‹é™ï¼Œè€Œä¸€æ—¦è£…è½½ç‡è¾¾åˆ° 100%ï¼Œæ•´ä¸ªå“ˆå¸Œè¡¨å°±ä¼šå®Œå…¨å¤±æ•ˆï¼Œè¿™æ—¶æŸ¥æ‰¾å’Œæ’å…¥ä»»æ„å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ ğ‘‚(ğ‘›) çš„ï¼Œè¿™æ—¶éœ€è¦éå†æ•°ç»„ä¸­çš„å…¨éƒ¨å…ƒç´ ï¼Œæ‰€ä»¥åœ¨å®ç°å“ˆå¸Œè¡¨æ—¶ä¸€å®šè¦å…³æ³¨è£…è½½å› å­çš„å˜åŒ–ã€‚

### æ‹‰é“¾å¼

å®ç°æ‹‰é“¾æ³•ä¸€èˆ¬ä¼šä½¿ç”¨æ•°ç»„åŠ ä¸Šé“¾è¡¨ï¼Œä¸è¿‡ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¼šåœ¨æ‹‰é“¾æ³•çš„å“ˆå¸Œä¸­å¼•å…¥çº¢é»‘æ ‘ä»¥ä¼˜åŒ–æ€§èƒ½ï¼Œæ‹‰é“¾æ³•ä¼šä½¿ç”¨é“¾è¡¨æ•°ç»„ä½œä¸ºå“ˆå¸Œåº•å±‚çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒçœ‹æˆå¯ä»¥æ‰©å±•çš„äºŒç»´æ•°ç»„ï¼š

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªé”®å€¼å¯¹ (Key6, Value6) å†™å…¥å“ˆå¸Œè¡¨æ—¶ï¼Œé”®å€¼å¯¹ä¸­çš„é”® Key6 éƒ½ä¼šå…ˆç»è¿‡ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œå“ˆå¸Œå‡½æ•°è¿”å›çš„å“ˆå¸Œä¼šå¸®åŠ©æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªæ¡¶ï¼Œå’Œå¼€æ”¾åœ°å€æ³•ä¸€æ ·ï¼Œé€‰æ‹©æ¡¶çš„æ–¹å¼æ˜¯ç›´æ¥å¯¹å“ˆå¸Œè¿”å›çš„ç»“æœå–æ¨¡ï¼š

index := hash("Key6") % array.len

é€‰æ‹©äº† 2 å·æ¡¶åå°±å¯ä»¥éå†å½“å‰æ¡¶ä¸­çš„é“¾è¡¨äº†ï¼Œåœ¨éå†é“¾è¡¨çš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š

1. æ‰¾åˆ°é”®ç›¸åŒçš„é”®å€¼å¯¹ â€” æ›´æ–°é”®å¯¹åº”çš„å€¼ï¼›
2. æ²¡æœ‰æ‰¾åˆ°é”®ç›¸åŒçš„é”®å€¼å¯¹ â€” åœ¨é“¾è¡¨çš„æœ«å°¾è¿½åŠ æ–°çš„é”®å€¼å¯¹ï¼›

## go è¯­è¨€çš„mapå®ç°åŸç†

é¦–å…ˆï¼Œgo map çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
```go
// A header for a Go map.
type hmap struct {
	// Note: the format of the hmap is also encoded in cmd/compile/internal/reflectdata/reflect.go.
	// Make sure this stays in sync with the compiler's definition.
	count     int // # live cells == size of map.  Must be first (used by len() builtin)
	flags     uint8
	B         uint8  // log_2 of # of buckets (can hold up to loadFactor * 2^B items)
	noverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details
	hash0     uint32 // hash seed
	buckets    unsafe.Pointer // array of 2^B Buckets. may be nil if count==0.
	oldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing
	nevacuate  uintptr        // progress counter for evacuation (buckets less than this have been evacuated)

	extra *mapextra // optional fields
}

// mapextra holds fields that are not present on all maps.
type mapextra struct {
	// If both key and elem do not contain pointers and are inline, then we mark bucket
	// type as containing no pointers. This avoids scanning such maps.
	// However, bmap.overflow is a pointer. In order to keep overflow buckets
	// alive, we store pointers to all overflow buckets in hmap.extra.overflow and hmap.extra.oldoverflow.
	// overflow and oldoverflow are only used if key and elem do not contain pointers.
	// overflow contains overflow buckets for hmap.buckets.
	// oldoverflow contains overflow buckets for hmap.oldbuckets.
	// The indirection allows to store a pointer to the slice in hiter.
	overflow    *[]*bmap
	oldoverflow *[]*bmap

	// nextOverflow holds a pointer to a free overflow bucket.
	nextOverflow *bmap
}
```
æˆ‘å°†å…¶æŠ½è±¡ä¸ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![](./2022-05-30-21-00-22.png)

å…¶ä¸­ï¼Œcount ä¸ºå½“å‰å“ˆå¸Œè¡¨çš„å…ƒç´ æ•°é‡

Bä¸ºå½“å‰å“ˆå¸Œè¡¨æ‹¥æœ‰çš„bucketçš„æ•°é‡

hash0ä¸ºå“ˆå¸Œçš„ç§å­ï¼Œä»–èƒ½ä¸ºå“ˆå¸Œå‡½æ•°çš„ç»“æœå¼•å…¥éšæœºæ€§ï¼Œè¿™ä¸ªå€¼åœ¨åˆ›å»ºå“ˆå¸Œè¡¨æ—¶å°±ç¡®å®šäº†ï¼Œå¹¶åœ¨è°ƒç”¨å“ˆå¸Œå‡½æ•°æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚

oldbuckets æ˜¯å“ˆå¸Œåœ¨æ‰©å®¹æ—¶ç”¨äºä¿å­˜ä¹‹å‰çš„bucketsçš„å­—æ®µï¼Œå®ƒçš„å¤§å°æ˜¯å½“å‰bucketsçš„ä¸€åŠã€‚

å¦‚ä¸Šå›¾æ‰€ç¤ºå“ˆå¸Œè¡¨ `runtime.hmap` çš„æ¡¶æ˜¯ `runtime.bmap`ã€‚æ¯ä¸€ä¸ª `runtime.bmap` éƒ½èƒ½å­˜å‚¨ 8 ä¸ªé”®å€¼å¯¹ï¼Œå½“å“ˆå¸Œè¡¨ä¸­å­˜å‚¨çš„æ•°æ®è¿‡å¤šï¼Œå•ä¸ªæ¡¶å·²ç»è£…æ»¡æ—¶å°±ä¼šä½¿ç”¨ `extra.nextOverflow` ä¸­æ¡¶å­˜å‚¨æº¢å‡ºçš„æ•°æ®ã€‚

ä¸Šè¿°ä¸¤ç§ä¸åŒçš„æ¡¶åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå°†å®ƒä»¬åˆ†åˆ«ç§°ä¸ºæ­£å¸¸æ¡¶å’Œæº¢å‡ºæ¡¶ï¼Œä¸Šå›¾ä¸­é»„è‰²çš„ `runtime.bmap` å°±æ˜¯æ­£å¸¸æ¡¶ï¼Œç»¿è‰²çš„ `runtime.bmap` æ˜¯æº¢å‡ºæ¡¶ã€‚


## map çš„è¯»å†™åŸç†å‰–æ
å…ˆçœ‹çœ‹ map çš„è¯»å†™æµç¨‹ï¼š
makemap

æºç è§£æå¦‚ä¸‹ï¼š
```
```

## map çš„æ‰©å®¹

## æ€»ç»“